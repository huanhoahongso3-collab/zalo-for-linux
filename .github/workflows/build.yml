name: Build Zalo for Linux

on:
  workflow_dispatch:
    inputs:
      dmg_version:
        description: 'Zalo Version (leave empty for latest)'
        required: false
        default: ''
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Cache Electron binaries
      uses: actions/cache@v3
      with:
        path: ~/.cache/electron
        key: ${{ runner.os }}-electron-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-electron-
          
    - name: Install Node.js dependencies
      run: npm ci --prefer-offline --no-audit
      
    - name: Setup Zalo (Download + Extract)
      env:
        DMG_VERSION: ${{ github.event.inputs.dmg_version }}
      run: |
        npm run setup
        
    - name: Build AppImage
      id: build
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸ”¨ Building Zalo AppImage..."
        npm run build
        
    - name: Upload Original AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.build.outputs.original_appimage_name }}
        path: ${{ steps.build.outputs.original_appimage_file }}
        retention-days: 30
        
    - name: Upload ZaDark AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.build.outputs.zadark_appimage_name }}
        path: ${{ steps.build.outputs.zadark_appimage_file }}
        retention-days: 30
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.build.outputs.release_tag }}
        name: ${{ steps.build.outputs.release_tag }}
        body: |          
          ğŸ‰ **Unofficial Zalo port for Linux systems**
          - This is an **unofficial** port from the macOS version
          - Build date: **${{ steps.build.outputs.release_tag }}**
          - Zalo version: **${{ steps.build.outputs.zalo_version }}**
          - Build mode: ${{ github.event.inputs.dmg_version && format('Specific version ({0})', github.event.inputs.dmg_version) || 'Latest version (auto-detected)' }}
          
          ## ğŸ“¥ Downloads
          
          ### ğŸ“¦ Original Version
          - **File**: `${{ steps.build.outputs.original_appimage_name }}`
          - **Size**: `${{ steps.build.outputs.original_file_size }}`
          - **SHA256**: `${{ steps.build.outputs.original_file_sha256 }}`
          
          ### ğŸŒŸ ZaDark Version (Recommended)
          - **File**: `${{ steps.build.outputs.zadark_appimage_name }}`
          - **Size**: `${{ steps.build.outputs.zadark_file_size }}`
          - **SHA256**: `${{ steps.build.outputs.zadark_file_sha256 }}`
          
          ## ğŸš€ How to use
          ```bash
          # Download and verify (ZaDark version)
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.build.outputs.release_tag }}/${{ steps.build.outputs.zadark_appimage_name }}
          echo "${{ steps.build.outputs.zadark_file_sha256 }}  ${{ steps.build.outputs.zadark_appimage_name }}" | sha256sum -c
          
          # Make executable and run
          chmod +x ${{ steps.build.outputs.zadark_appimage_name }}
          ./${{ steps.build.outputs.zadark_appimage_name }}
          ```

          ## ğŸ“‹ System Requirements
          - Linux x64
          - GLIBC 2.28 or later
          - Desktop environment with system tray support (recommended)
          
          ## ğŸ› Issues & Support
          Please report issues in the [GitHub Issues](https://github.com/${{ github.repository }}/issues) section.
          
          ---
          *Built automatically from macOS version using GitHub Actions*
        files: |
          ${{ steps.build.outputs.original_appimage_file }}
          ${{ steps.build.outputs.zadark_appimage_file }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 